<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inventory Store — Admin & Customer Demo</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4;
    --success:#10b981; --danger:#ef4444; --glass: rgba(255,255,255,0.04);
    --radius:12px; --glass-2: rgba(255,255,255,0.02);
    font-family: Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; background:
    linear-gradient(180deg,#071022 0%, #07112b 50%, #041018 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Layout */
  .container{ max-width:1100px; margin:28px auto; padding:20px; }
  .topbar{ display:flex; align-items:center; gap:16px; justify-content:space-between; }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{ width:52px; height:52px; background:linear-gradient(135deg,var(--accent),#7c3aed);
        border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#001; }
  h1{ margin:0; font-size:20px; letter-spacing:0.2px; }
  .subtitle{ color:var(--muted); font-size:13px; margin-top:3px; }

  /* Controls */
  .controls{ display:flex; gap:10px; align-items:center; }
  button.cta{ background:linear-gradient(90deg,var(--accent),#7c3aed); color:#001; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(7,12,20,0.6); }
  button.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); padding:8px 12px; border-radius:10px; cursor:pointer; }
  .rolePill{ background:var(--glass); padding:8px 10px; border-radius:999px; color:var(--muted); font-weight:600; font-size:13px; }

  /* Grid */
  .grid{ display:grid; grid-template-columns: 1fr 380px; gap:20px; margin-top:18px; align-items:start; }
  .card{ background:linear-gradient(180deg,var(--card),#071122); padding:18px; border-radius:var(--radius); box-shadow:0 6px 18px rgba(5,9,15,0.6); border:1px solid var(--glass-2); }
  .card h2{ margin:0 0 8px 0; font-size:16px; }
  .muted{ color:var(--muted); font-size:13px; }

  /* Product grid */
  .products{ display:grid; grid-template-columns: repeat(auto-fill,minmax(230px,1fr)); gap:12px; }
  .product{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03);
  }
  .product h3{ margin:0; font-size:14px; }
  .pmeta{ color:var(--muted); font-size:13px; margin-top:6px; display:flex; justify-content:space-between; align-items:center; }
  .stk{ font-weight:700; padding:6px 8px; border-radius:8px; font-size:12px; }
  .stk.low{ background:rgba(255,255,255,0.02); color:var(--accent); border:1px solid rgba(6,182,212,0.12); }
  .stk.out{ background:rgba(255,0,0,0.06); color:var(--danger); border:1px solid rgba(255,0,0,0.12); }

  .product .actions{ margin-top:10px; display:flex; gap:8px; }
  .btn{ padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
  .btn.primary{ background:var(--accent); color:#001; }
  .btn.warm{ background: #f97316; color:#001; }
  .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

  /* Sidebar */
  .side-section{ display:flex; flex-direction:column; gap:12px; }
  .info-row{ display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-radius:8px; background:var(--glass); }
  .small{ font-size:13px; color:var(--muted); }

  /* Forms */
  .form-row{ display:flex; gap:8px; margin-top:8px; }
  input[type="text"], input[type="number"], input[type="password"]{
    background:transparent; color:inherit; border:1px solid rgba(255,255,255,0.04);
    padding:8px 10px; border-radius:8px; outline:none; min-width:0;
  }

  /* Modal */
  .modal-back{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,12,0.6); z-index:60; }
  .modal{ width:780px; max-width:96%; background:linear-gradient(180deg,#071028,#03101b); border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 20px 50px rgba(2,6,15,0.7); }
  .modal h3{ margin:0 0 8px 0; }

  /* small */
  .tiny{ font-size:12px; color:var(--muted) }
  .row{ display:flex; gap:8px; align-items:center; }

  /* footer */
  footer{ margin-top:26px; color:var(--muted); text-align:center; font-size:13px; }

  /* responsive */
  @media (max-width:900px){
    .grid{ grid-template-columns: 1fr; }
    .logo{ width:44px; height:44px; }
  }

</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="logo">IS</div>
      <div>
        <h1>Inventory Store — Demo</h1>
        <div class="subtitle">Admin & Customer example — persistent in browser (localStorage)</div>
      </div>
    </div>

    <div class="controls">
      <div id="userInfo" class="rolePill">Not logged</div>
      <button class="ghost" id="openLogin">Login / Register</button>
      <button class="cta" id="saveBtn">Save</button>
    </div>
  </div>

  <div class="grid">
    <!-- main -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2>Products</h2>
            <div class="muted">Sorted by name (in-order traversal of BST)</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="searchId" type="text" placeholder="Search by ID" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"/>
            <button class="ghost" id="searchBtn">Search</button>
            <button class="ghost" id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div id="productsWrap" style="margin-top:14px;">
          <div class="products" id="productGrid"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Activity / Log</h2>
        <div id="log" class="muted tiny" style="max-height:160px; overflow:auto; padding-top:8px;"></div>
      </div>
    </div>

    <!-- sidebar -->
    <div class="side-section">
      <div class="card">
        <h2>Session</h2>
        <div class="info-row"><div class="small">Role</div><div id="roleBadge" class="muted tiny">Guest</div></div>
        <div class="info-row"><div class="small">Cart Items</div><div id="cartCount" class="muted tiny">0</div></div>
        <div class="info-row"><div class="small">Total Products</div><div id="totalCount" class="muted tiny">0</div></div>

        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn primary" id="openCartBtn">Open Cart</button>
          <button class="btn ghost" id="openAdminBtn">Admin Panel</button>
        </div>
      </div>

      <div class="card">
        <h2>Admin Shortcuts</h2>
        <div style="display:flex;flex-direction:column; gap:8px;">
          <button class="btn ghost" id="showLowStock">View Low Stock</button>
          <button class="btn ghost" id="addDummy">Add Dummy Product</button>
          <button class="btn ghost" id="clearStorage">Reset Storage</button>
        </div>
      </div>

      <div class="card">
        <h2>About</h2>
        <div class="muted tiny">This demo stores data in localStorage. Actions (buy, delete, add) update central store and UI instantly. The product list is sorted using a binary search tree implemented in JavaScript (in-order traversal).</div>
      </div>
    </div>
  </div>

  <footer>Made for demonstration • Admin: <b>admin/admin123</b> • Customers: <b>user1/pass1</b>, <b>user2/pass2</b></footer>
</div>

<!-- LOGIN / ADMIN / CART MODAL -->
<div id="modal" class="modal-back">
  <div class="modal" id="modalContent">
    <!-- dynamic content -->
  </div>
</div>

<script>
/* =========================
   Data structures & storage
   ========================= */

/* Product: plain object {id,name,quantity,price} */

/* productMap: Map from id -> product */
const productMap = new Map();

/* Binary Search Tree for sorting by name */
class BSTNode {
  constructor(product){
    this.product = product; this.left = null; this.right = null;
  }
}
class BST {
  constructor(){ this.root = null; }
  insert(product){
    this.root = this._insertRec(this.root, product);
  }
  _insertRec(node, product){
    if(!node) return new BSTNode(product);
    if(product.name < node.product.name) node.left = this._insertRec(node.left, product);
    else node.right = this._insertRec(node.right, product);
    return node;
  }
  // inorder traversal -> collect array
  inorder(){
    const out = [];
    (function rec(n){ if(!n) return; rec(n.left); out.push(n.product); rec(n.right); })(this.root);
    return out;
  }
  // delete by name (physical removal)
  deleteByName(name){
    this.root = this._deleteRec(this.root, name);
  }
  _deleteRec(node, name){
    if(!node) return null;
    if(name < node.product.name) node.left = this._deleteRec(node.left, name);
    else if(name > node.product.name) node.right = this._deleteRec(node.right, name);
    else {
      // found
      if(!node.left && !node.right) return null;
      if(!node.left) return node.right;
      if(!node.right) return node.left;
      // two children: replace with inorder successor
      let succ = node.right;
      while(succ.left) succ = succ.left;
      node.product = succ.product;
      node.right = this._deleteRec(node.right, succ.product.name);
    }
    return node;
  }
  clear(){ this.root = null; }
}

/* Simple Cart implemented as linked list (CartNode) */
class CartNode {
  constructor(productId, qty=1){
    this.productId = productId; this.qty = qty; this.next = null;
  }
}
class Cart {
  constructor(){ this.head = null; }
  add(productId, qty=1){
    if(qty <= 0) return;
    // if exists, increment
    let cur = this.head;
    while(cur){
      if(cur.productId === productId){ cur.qty += qty; return; }
      cur = cur.next;
    }
    const n = new CartNode(productId, qty);
    n.next = this.head; this.head = n;
  }
  view(){
    const out = [];
    let cur = this.head;
    while(cur){ out.push({id:cur.productId, qty:cur.qty}); cur = cur.next; }
    return out;
  }
  clear(){
    let cur = this.head;
    while(cur){ let nx = cur.next; cur.next = null; cur = nx; }
    this.head = null;
  }
  removeProduct(productId){
    // remove nodes with this id
    while(this.head && this.head.productId === productId) this.head = this.head.next;
    let cur = this.head;
    while(cur && cur.next){
      if(cur.next.productId === productId) cur.next = cur.next.next;
      else cur = cur.next;
    }
  }
  countItems(){
    let c=0, cur=this.head;
    while(cur){ c += cur.qty; cur = cur.next; } return c;
  }
}

/* single shared BST and cart for UI sessions */
const bst = new BST();
let sessionCart = new Cart(); // single cart for currently logged-in customer
let currentUser = null; // {username,role:'admin'|'customer'} or null

/* Logging helper */
function log(msg){
  const el = document.getElementById('log');
  const t = document.createElement('div'); t.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
  el.prepend(t);
}

/* =========================
   Persistence
   ========================= */
const STORAGE_KEY = 'inventory_demo_v1';
function saveAllToStorage(){
  const arr = [];
  for(const [id, p] of productMap.entries()){
    arr.push({id: p.id, name: p.name, quantity: p.quantity, price: p.price});
  }
  localStorage.setItem(STORAGE_KEY, JSON.stringify({products:arr, users: Object.fromEntries(Object.entries(users))}));
  log('Saved to localStorage');
}
function loadAllFromStorage(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const data = JSON.parse(raw);
    // clear existing
    productMap.clear(); bst.clear();
    if(data.products && Array.isArray(data.products)){
      data.products.forEach(p => {
        productMap.set(p.id, {id: p.id, name: p.name, quantity: p.quantity, price: p.price});
        bst.insert(productMap.get(p.id));
      });
    }
    if(data.users) {
      // handled below: users global replaced
    }
    return true;
  }catch(e){ console.error(e); return false; }
}

/* =========================
   Dummy users & default data
   ========================= */
const users = {}; // username -> password
function seedUsers(){
  users['admin'] = 'admin123';
  users['user1'] = 'pass1';
  users['user2'] = 'pass2';
}

function seedProductsIfEmpty(){
  if(productMap.size > 0) return;
  const defaults = [
    {id:101, name:'Laptop', quantity:10, price:120000},
    {id:102, name:'Mouse', quantity:3, price:1500},
    {id:103, name:'Keyboard', quantity:2, price:3000},
    {id:104, name:'Charger', quantity:6, price:1200},
    {id:105, name:'Headphones', quantity:8, price:4500},
  ];
  defaults.forEach(p=>{
    productMap.set(p.id, {...p});
    bst.insert(productMap.get(p.id));
  });
}

/* =========================
   UI rendering
   ========================= */
function renderProducts(){
  const grid = document.getElementById('productGrid');
  grid.innerHTML = '';
  const items = bst.inorder();
  if(items.length === 0){
    const emp = document.createElement('div'); emp.className='muted'; emp.textContent = 'No products available';
    grid.appendChild(emp); return;
  }
  items.forEach(p=>{
    // ensure product still exists in productMap (sync) - else skip
    if(!productMap.has(p.id)) return;
    const box = document.createElement('div'); box.className = 'product';
    const title = document.createElement('h3'); title.textContent = p.name;
    const meta = document.createElement('div'); meta.className = 'pmeta';
    const left = document.createElement('div');
    left.innerHTML = `<div class="tiny">ID: ${p.id}</div><div class="tiny">Price: ${p.price.toFixed(2)}</div>`;
    const right = document.createElement('div' );
    const stk = document.createElement('div'); stk.className='stk ' + (p.quantity<=0? 'out' : (p.quantity<5? 'low':'')); stk.textContent = (p.quantity<=0? 'OUT' : 'Qty '+p.quantity);
    right.appendChild(stk);
    meta.appendChild(left); meta.appendChild(right);

    box.appendChild(title); box.appendChild(meta);

    const actions = document.createElement('div'); actions.className='actions';
    const addBtn = document.createElement('button'); addBtn.className='btn primary'; addBtn.textContent='Add to Cart';
    addBtn.onclick = ()=>{
      if(currentUser && currentUser.role === 'customer'){
        if(p.quantity<=0){ alert('Out of stock'); return; }
        sessionCart.add(p.id, 1); toast(`Added ${p.name} to cart`); updateUICounts(); log(`Added ${p.name} to cart`);
      } else {
        toast('Login as customer to add to cart');
      }
    };
    const buyBtn = document.createElement('button'); buyBtn.className='btn warm'; buyBtn.textContent = 'Buy Now';
    buyBtn.onclick = ()=>{
      if(!currentUser || currentUser.role !== 'customer'){ toast('Login as customer to buy'); return; }
      if(p.quantity<=0){ toast('Out of stock'); return; }
      // process buy: reduce stock by 1
      processBuy(p.id, 1);
    };

    const adminDelete = document.createElement('button'); adminDelete.className='btn ghost'; adminDelete.textContent='Delete';
    adminDelete.onclick = ()=>{
      if(!currentUser || currentUser.role!=='admin'){ toast('Admin only'); return; }
      if(confirm('Delete product "'+p.name+'"?')){ deleteProductByIdUI(p.id); }
    };

    actions.appendChild(addBtn); actions.appendChild(buyBtn);
    if(currentUser && currentUser.role==='admin') actions.appendChild(adminDelete);
    box.appendChild(actions);
    grid.appendChild(box);
  });
}

/* small UI helpers */
function setUserInfo(){
  const info = document.getElementById('userInfo');
  const badge = document.getElementById('roleBadge');
  if(!currentUser){ info.textContent='Not logged'; badge.textContent='Guest'; }
  else { info.textContent = currentUser.username; badge.textContent = currentUser.role; }
  updateUICounts();
}
function updateUICounts(){
  document.getElementById('totalCount').textContent = productMap.size;
  document.getElementById('cartCount').textContent = sessionCart.countItems();
}

/* toast */
function toast(msg){
  alert(msg);
}

/* =========================
   Business logic: add/delete/buy & UI sync
   ========================= */
function addProductUI(id, name, qty, price){
  if(productMap.has(id)){ toast('ID exists'); return; }
  // name uniqueness
  for(const p of productMap.values()) if(p.name === name){ toast('Name exists'); return; }
  productMap.set(id, {id, name, quantity:qty, price});
  bst.insert(productMap.get(id));
  if(qty>0 && qty<5) addToLowStock(productMap.get(id));
  log(`Admin added product ${name} (id:${id})`);
  renderProducts(); updateUICounts();
}

function deleteProductByIdUI(id){
  const p = productMap.get(id);
  if(!p){ toast('Not found'); return; }
  bst.deleteByName(p.name);
  productMap.delete(id);
  // also remove from cart(s) — here only sessionCart exists
  sessionCart.removeProduct(id);
  renderProducts(); updateUICounts(); log(`Product deleted: ${p.name}`);
}

function processBuy(id, amount){
  const p = productMap.get(id);
  if(!p){ toast('Product not found'); return; }
  if(p.quantity <= 0){ toast('Out of stock'); return; }
  if(amount >= p.quantity){
    // buy all -> remove product
    const qtyBought = p.quantity;
    bst.deleteByName(p.name);
    productMap.delete(id);
    sessionCart.removeProduct(id);
    renderProducts();
    updateUICounts();
    log(`Bought ALL ${p.name} x${qtyBought} — removed from inventory`);
    toast(`Bought ${p.name} x${qtyBought}`);
  } else {
    p.quantity -= amount;
    if(p.quantity < 5) addToLowStock(p);
    renderProducts(); updateUICounts();
    log(`Bought ${p.name} x${amount} — remaining ${p.quantity}`);
    toast(`Bought ${p.name} x${amount}`);
  }
}

/* =========================
   Low stock display
   ========================= */
function showLowStockModal(){
  const products = [];
  for(const p of productMap.values()) if(p.quantity>0 && p.quantity<5) products.push(p);
  showModal(`<h3>Low Stock</h3>
    <div class="muted tiny">Products with qty &lt; 5</div>
    <div style="margin-top:12px;">
      ${products.length? products.map(p=>`<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:6px;">
        <b>${p.name}</b> — ID: ${p.id} — Qty: ${p.quantity}
      </div>`).join('') : '<div class="tiny muted">No low stock items</div>'}
    </div>
    <div style="margin-top:12px; text-align:right;"><button class="ghost" onclick="closeModal()">Close</button></div>
  `);
}

/* =========================
   Cart modal & checkout
   ========================= */
function openCartModal(){
  const items = sessionCart.view();
  if(items.length === 0){ showModal(`<h3>Your Cart</h3><div class="muted tiny" style="margin-top:8px;">Cart is empty</div><div style="margin-top:12px;text-align:right;"><button class="ghost" onclick="closeModal()">Close</button></div>`); return;}
  let total = 0;
  let html = `<h3>Your Cart</h3><div style="margin-top:10px;">`;
  items.forEach(it=>{
    const p = productMap.get(it.id);
    if(!p) html += `<div class="tiny muted">Item removed from store (ID: ${it.id})</div>`;
    else {
      html += `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:6px;">
        <b>${p.name}</b> — Qty: ${it.qty} — Unit: ${p.price.toFixed(2)}
      </div>`;
      total += (p? p.price * it.qty : 0);
    }
  });
  html += `</div>
    <div style="margin-top:8px;"><b>Total (approx): </b> ${total.toFixed(2)}</div>
    <div style="margin-top:12px;text-align:right;">
      <button class="ghost" onclick="closeModal()">Close</button>
      <button class="cta" onclick="checkoutCartUI()">Checkout</button>
    </div>
  `;
  showModal(html);
}

function checkoutCartUI(){
  // process each cart item
  let cur = sessionCart.head;
  while(cur){
    const id = cur.productId, want = cur.qty;
    const p = productMap.get(id);
    if(!p){ log(`Skipping ${id} - removed`); cur = cur.next; continue; }
    if(p.quantity <= 0){ log(`Skipping ${p.name} - out of stock`); cur = cur.next; continue; }
    if(want >= p.quantity){
      // buy all
      const bought = p.quantity;
      bst.deleteByName(p.name);
      productMap.delete(id);
      sessionCart.removeProduct(id);
      log(`Bought ALL ${p.name} x${bought}`);
    } else {
      p.quantity -= want;
      if(p.quantity < 5) addToLowStock(p);
      log(`Bought ${p.name} x${want} — remaining ${p.quantity}`);
    }
    cur = cur.next;
  }
  sessionCart.clear();
  renderProducts(); updateUICounts(); closeModal(); toast('Checkout complete');
}

/* =========================
   Modal utilities
   ========================= */
function showModal(html){
  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');
  content.innerHTML = html;
  modal.style.display = 'flex';
}
function closeModal(){
  const modal = document.getElementById('modal');
  modal.style.display = 'none';
}

/* =========================
   Login & admin panel UI
   ========================= */
function openLoginModal(){
  showModal(`<h3>Login / Register</h3>
    <div class="muted tiny">Use admin/admin123 for admin, user1/pass1 user2/pass2 as customers (dummy)</div>
    <div style="margin-top:12px;">
      <div class="row" style="margin-bottom:8px;">
        <input id="m-username" type="text" placeholder="username" />
        <input id="m-password" type="password" placeholder="password" />
      </div>
      <div style="text-align:right;">
        <button class="ghost" onclick="closeModal()">Close</button>
        <button class="cta" onclick="modalRegister()">Register</button>
        <button class="cta" onclick="modalLogin()">Login</button>
      </div>
    </div>
  `);
  document.getElementById('m-username').focus();
}

function modalRegister(){
  const u = document.getElementById('m-username').value.trim();
  const p = document.getElementById('m-password').value.trim();
  if(!u||!p){ toast('Enter username & password'); return; }
  if(users[u]){ toast('Username exists'); return; }
  users[u] = p; toast('Registered. Now login'); log(`Registered user ${u}`);
}

function modalLogin(){
  const u = document.getElementById('m-username').value.trim();
  const p = document.getElementById('m-password').value.trim();
  if(!u||!p){ toast('Enter username & password'); return; }
  if(users[u] && users[u] === p){
    // success
    currentUser = {username:u, role: (u==='admin' ? 'admin' : 'customer')};
    closeModal(); setUserInfo(); renderProducts();
    toast('Login success as ' + currentUser.role);
    log(`Login: ${u} (${currentUser.role})`);
  } else {
    toast('Invalid credentials');
  }
}

function openAdminPanel(){
  if(!currentUser || currentUser.role !== 'admin'){ toast('Login as admin'); return; }
  showModal(`<h3>Admin Panel</h3>
    <div style="display:flex;gap:12px;">
      <div style="flex:1;">
        <div class="muted tiny">Add Product</div>
        <div class="form-row" style="margin-top:8px;">
          <input id="adm-id" type="number" placeholder="ID" />
          <input id="adm-name" type="text" placeholder="Name" />
        </div>
        <div class="form-row" style="margin-top:8px;">
          <input id="adm-qty" type="number" placeholder="Qty" />
          <input id="adm-price" type="number" placeholder="Price" />
        </div>
        <div style="margin-top:8px;text-align:right;">
          <button class="ghost" onclick="closeModal()">Close</button>
          <button class="cta" onclick="modalAddProduct()">Add Product</button>
        </div>
      </div>
      <div style="width:320px;">
        <div class="muted tiny">Quick Controls</div>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <button class="ghost" onclick="showLowStockModal()">Low Stock</button>
          <button class="ghost" onclick="saveAllToStorage()">Save</button>
          <button class="ghost" onclick="closeModal()">Close</button>
        </div>
        <div style="margin-top:12px;">
          <div class="muted tiny">Search & Manage (by ID)</div>
          <div class="form-row" style="margin-top:8px;">
            <input id="adm-search-id" type="number" placeholder="ID" />
            <button class="ghost" onclick="adminFind()">Find</button>
          </div>
          <div id="admManage" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  `);
}

function modalAddProduct(){
  const id = Number(document.getElementById('adm-id').value);
  const name = document.getElementById('adm-name').value.trim();
  const qty = Number(document.getElementById('adm-qty').value);
  const price = Number(document.getElementById('adm-price').value);
  if(!id || !name || isNaN(qty) || isNaN(price)){ toast('Fill fields correctly'); return; }
  addProductUI(id, name, qty, price);
  closeModal();
}

function adminFind(){
  const id = Number(document.getElementById('adm-search-id').value);
  const cont = document.getElementById('admManage');
  cont.innerHTML = '';
  if(!id || !productMap.has(id)){ cont.innerHTML = '<div class="tiny muted">Product not found</div>'; return; }
  const p = productMap.get(id);
  cont.innerHTML = `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)">
    <b>${p.name}</b> — Qty: ${p.quantity} — Price: ${p.price}
    <div style="margin-top:8px;">
      <button class="ghost" onclick="deleteProductByIdUI(${p.id})">Delete</button>
      <button class="ghost" onclick="restockPrompt(${p.id})">Restock</button>
    </div>
  </div>`;
}

function restockPrompt(id){
  const newQty = Number(prompt('Enter new total quantity for product ID ' + id));
  if(isNaN(newQty)) { toast('Invalid qty'); return; }
  updateStockUI(id, newQty);
  adminFind();
}

function updateStockUI(id, qty){
  const p = productMap.get(id);
  if(!p){ toast('Not found'); return; }
  p.quantity = qty;
  if(qty>0 && qty<5) addToLowStock(p);
  renderProducts(); updateUICounts(); log(`Admin updated stock ${p.name} -> ${qty}`);
  toast('Updated');
}

/* =========================
   Helpers for UI actions (event listeners)
   ========================= */
document.getElementById('openLogin').onclick = openLoginModal;
document.getElementById('openAdminBtn').onclick = openAdminPanel;
document.getElementById('openCartBtn').onclick = openCartModal;
document.getElementById('saveBtn').onclick = saveAllToStorage;
document.getElementById('showLowStock').onclick = showLowStockModal;
document.getElementById('addDummy').onclick = ()=>{
  const nextId = Math.max(100, ...Array.from(productMap.keys())) + 1;
  addProductUI(nextId, 'Product'+nextId, Math.floor(Math.random()*10)+1, (Math.random()*9000+300).toFixed(2));
};
document.getElementById('clearStorage').onclick = ()=>{
  if(confirm('This will clear saved local data and reset demo. Continue?')){
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
};
document.getElementById('refreshBtn').onclick = ()=>{ renderProducts(); updateUICounts(); };
document.getElementById('searchBtn').onclick = ()=>{
  const id = Number(document.getElementById('searchId').value);
  if(!id) { toast('Enter ID'); return; }
  if(!productMap.has(id)){ toast('Not found'); return; }
  const p = productMap.get(id);
  alert(`Found: ${p.name} — Qty: ${p.quantity} — Price: ${p.price}`);
};

/* =========================
   Save / load wrappers mapping to local storage functions above
   ========================= */
function saveAllToStorage(){
  const items = [];
  for(const [id,p] of productMap.entries()) items.push({id:p.id, name:p.name, quantity:p.quantity, price:p.price});
  localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  toast('Saved to localStorage');
  log('Saved data to localStorage');
}
function loadAllFromStorage(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const arr = JSON.parse(raw);
    productMap.clear(); bst.clear();
    arr.forEach(p=>{
      productMap.set(p.id, {id:p.id, name:p.name, quantity:p.quantity, price:p.price});
      bst.insert(productMap.get(p.id));
    });
    return true;
  }catch(e){ console.error(e); return false; }
}

/* =========================
   Init
   ========================= */
(function init(){
  seedUsers();
  const loaded = loadAllFromStorage();
  if(!loaded) seedProductsIfEmpty();
  renderProducts();
  setUserInfo();
  updateUICounts();
  log('App loaded');
})();

/* =========================
   Small global helpers used in html onclick contexts
   ========================= */
window.closeModal = closeModal;
window.showModal = showModal;
window.addProductUI = addProductUI;
window.deleteProductByIdUI = deleteProductByIdUI;
window.checkoutCartUI = checkoutCartUI;
window.openCartModal = openCartModal;
window.modalLogin = modalLogin;
window.modalRegister = modalRegister;
window.openLoginModal = openLoginModal;
window.updateStockUI = updateStockUI;
window.saveAllToStorage = saveAllToStorage;
</script>
</body>
</html>
